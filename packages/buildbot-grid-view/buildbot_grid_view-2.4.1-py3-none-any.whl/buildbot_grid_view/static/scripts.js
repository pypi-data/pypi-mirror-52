!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("angular-animate"),require("guanlecoja-ui"),require("buildbot-data-js")):"function"==typeof define&&define.amd?define("buildbot-grid-view",["angular-animate","guanlecoja-ui","buildbot-data-js"],t):"object"==typeof exports?exports["buildbot-grid-view"]=t(require("angular-animate"),require("guanlecoja-ui"),require("buildbot-data-js")):e["buildbot-grid-view"]=t(e["angular-animate"],e["guanlecoja-ui"],e["buildbot-data-js"])}("undefined"!=typeof self?self:this,function(e,t,s){return function(e){var t={};function s(i){if(t[i])return t[i].exports;var a=t[i]={i:i,l:!1,exports:{}};return e[i].call(a.exports,a,a.exports,s),a.l=!0,a.exports}return s.m=e,s.c=t,s.d=function(e,t,i){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)s.d(i,a,function(t){return e[t]}.bind(null,a));return i},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s=0)}([function(e,t,s){"use strict";s.r(t);s(1),s(2),s(3);angular.module("grid_view",["ui.router","ui.bootstrap","ngAnimate","guanlecoja.ui","bbData"]).config(["$stateProvider","glMenuServiceProvider","bbSettingsServiceProvider",class GridState{constructor(e,t,i){t.addGroup({name:"grid",caption:"Grid View",icon:"cubes",order:4}),e.state({name:"grid",controller:"gridController",controllerAs:"C",template:s(4),url:"/grid?branch&tag&result",reloadOnSearch:!1,data:{group:"grid",caption:"Grid View"}}),i.addSettingsGroup({name:"Grid",caption:"Grid related settings",items:[{type:"bool",name:"fullChanges",caption:"Show avatar and time ago in change details",defaultValue:!1},{type:"bool",name:"leftToRight",caption:"Show most recent changes on the right",defaultValue:!1},{type:"integer",name:"revisionLimit",caption:"Maximum number of revisions to display",default_value:5},{type:"integer",name:"changeFetchLimit",caption:"Maximum number of changes to fetch",default_value:100},{type:"integer",name:"buildFetchLimit",caption:"Maximum number of builds to fetch",default_value:1e3}]})}}]),s(5)},function(t,s){t.exports=e},function(e,s){e.exports=t},function(e,t){e.exports=s},function(e,t){e.exports=window.T["grid_view/grid.html"]||'<div class="container grid"><div class="load-indicator" ng-hide="C.dataFetched()"><div class="spinner"><i class="fa fa-circle-o-notch fa-spin fa-2x"></i><p>loading</p></div></div><p ng-show="C.dataFetched() &amp;&amp; C.changes.length == 0">No changes. Grid View needs a changesource to be setup, and<a href="#/changes"> changes</a> to be in the system.</p><div class="form-inline" ng-show="C.dataReady()"><div class="form-group"><label>Branch</label><select class="form-control" ng-model="C.branch" ng-change="C.changeBranch(C.branch)" ng-options="br for br in branches | orderBy"><option value="">(all)</option></select></div><div class="form-group"><label>Results</label><select class="form-control" ng-model="C.result" ng-change="C.changeResult(C.result)" ng-options="r.code as r.text for r in C.results"><option value="">(all)</option></select></div></div><table class="table table-condensed table-striped table-hover" ng-show="C.dataReady()"><thead><tr><th>Builder</th><th><span ng-show="C.tags.length == 0">Tags</span><span ng-show="C.tags.length &lt; 5" ng-repeat="tag in C.tags"><span class="builder-tag label clickable label-success" ng-click="C.toggleTag(tag)">{{ tag }}</span></span><span ng-show="C.tags.length &gt;= 5"><span class="label label-success">{{ C.tags.length }} tags</span></span><span ng-show="C.tags.length &gt; 0"><span class="label label-danger clickable" ng-click="C.resetTags()" uib-tooltip="Reset tags filter">x</span></span></th><th class="change" ng-repeat="ch in changes track by ch.changeid"><changedetails change="ch" compact="!C.fullChanges"></changedetails></th></tr></thead><tbody><tr ng-repeat="b in builders | orderBy: \'name\'"><th><a ui-sref="builder({builder: b.builderid})">{{ b.name }}</a></th><td><span ng-repeat="tag in b.tags"><span class="builder-tag label clickable" ng-click="C.toggleTag(tag)" ng-class="C.isTagToggled(tag) ? \'label-success\': \'label-default\'">{{ tag }}</span></span></td><td ng-repeat="ch in changes track by ch.changeid"><a ng-repeat="build in b.builds[ch.changeid] | orderBy: \'buildid\'" ui-sref="build({builder: b.builderid, build: build.number})"><span class="badge-status" ng-class="results2class(build, \'pulse\')">{{ build.number }}</span></a></td></tr></tbody></table></div>'},function(e,t){angular.module("grid_view").controller("gridController",["$scope","$stateParams","$state","resultsService","dataService","bbSettingsService",class Grid{constructor(e,t,s,i,a,r){this.onChange=this.onChange.bind(this),this.changeBranch=this.changeBranch.bind(this),this.changeResult=this.changeResult.bind(this),this.toggleTag=this.toggleTag.bind(this),this.resetTags=this.resetTags.bind(this),this.refresh=this.refresh.bind(this),this.isBuilderDisplayed=this.isBuilderDisplayed.bind(this),this.isTagToggled=this.isTagToggled.bind(this),this.$scope=e,this.$stateParams=t,this.$state=s,_.mixin(this.$scope,i),this.data=a.open().closeOnDestroy(this.$scope),this.branch=this.$stateParams.branch,this.tags=null!=this.$stateParams.tag?this.$stateParams.tag:[],angular.isArray(this.tags)||(this.tags=[this.tags]),this.result=this.$stateParams.result,this.results=(()=>{var e=[];for(var t in i.resultsTexts){var s=i.resultsTexts[t];e.push({code:t+"",text:s})}return e})();var n=r.getSettingsGroup("Grid");this.revisionLimit=n.revisionLimit.value,this.changeFetchLimit=n.changeFetchLimit.value,this.buildFetchLimit=n.buildFetchLimit.value,this.fullChanges=n.fullChanges.value,this.leftToRight=n.leftToRight.value,this.buildsets=this.data.getBuildsets({limit:this.buildFetchLimit,order:"-bsid"}),this.changes=this.data.getChanges({limit:this.changeFetchLimit,order:"-changeid"}),this.builders=this.data.getBuilders(),this.buildrequests=this.data.getBuildrequests({limit:this.buildFetchLimit,order:"-buildrequestid"}),this.builds=this.data.getBuilds({limit:this.buildFetchLimit,order:"-buildrequestid"}),this.buildsets.onChange=this.onChange,this.changes.onChange=this.onChange,this.builders.onChange=this.onChange,this.buildrequests.change=this.onChange,this.builds.onChange=this.onChange}dataReady(){for(var e=0,t=[this.buildsets,this.changes,this.builders,this.buildrequests,this.builds];e<t.length;e++){var s=t[e];if(!(s.$resolved&&s.length>0))return!1}return!0}dataFetched(){for(var e=0,t=[this.buildsets,this.changes,this.builders,this.buildrequests,this.builds];e<t.length;e++)if(!t[e].$resolved)return!1;return!0}onChange(){var e,t,s,i,a,r;if(this.dataReady()){for(var n={},l={},h={},u=0,o=Array.from(this.changes);u<o.length;u++)h[(t=o[u]).sourcestamp.ssid]=t,t.buildsets={};for(var d=0,g=Array.from(this.buildsets);d<g.length;d++)e=g[d],null!=(i=h[_.last(e.sourcestamps).ssid])&&(i.buildsets[e.bsid]=e,null==i.branch&&(i.branch="master"),l[i.branch]=!0,this.branch&&i.branch!==this.branch||(n[i.changeid]=i));n=(()=>{for(var e=[],t=0,s=Object.keys(n||{});t<s.length;t++){var a=s[t];i=n[a],e.push(i)}return e})(),this.leftToRight?(n.sort((e,t)=>e.changeid-t.changeid),n.length>this.revisionLimit&&(n=n.slice(n.length-this.revisionLimit))):(n.sort((e,t)=>t.changeid-e.changeid),n.length>this.revisionLimit&&(n=n.slice(0,this.revisionLimit))),this.$scope.changes=n,this.$scope.branches=(()=>{var e=[];for(var t in l)e.push(t);return e})();for(var c={},b=0,p=Array.from(this.buildrequests);b<p.length;b++)(null!=c[(s=p[b]).buildsetid]?c[s.buildsetid]:c[s.buildsetid]=[]).push(s);for(var f={},m=0,v=Array.from(this.builds);m<v.length;m++){var y=v[m];(null!=f[y.buildrequestid]?f[y.buildrequestid]:f[y.buildrequestid]=[]).push(y)}for(var C=0,T=Array.from(this.builders);C<T.length;C++)(r=T[C]).builds={};for(var $={},x=0,j=Array.from(this.$scope.changes);x<j.length;x++){t=j[x];for(var w=0,P=Object.keys(t.buildsets||{});w<P.length;w++){var q=P[w];e=t.buildsets[q];var S=c[q];if(null!=S)for(var B=0,L=Array.from(S);B<L.length;B++){var O=null!=f[(s=L[B]).buildrequestid]?f[s.buildrequestid]:[];if(null!=this.result&&""!==this.result&&!isNaN(this.result))for(a=0;a<O.length;)parseInt(O[a].results)!==parseInt(this.result)?O.splice(a,1):a+=1;O.length>0&&(r=this.builders.get(O[0].builderid),this.isBuilderDisplayed(r)&&($[r.builderid]=r,r.builds[t.changeid]=O))}}}return this.$scope.builders=(()=>{for(var e=[],t=0,s=Object.keys($||{});t<s.length;t++)a=s[t],r=$[a],e.push(r);return e})()}}changeBranch(e){return this.branch=e,this.refresh()}changeResult(e){return this.result=e,this.refresh()}toggleTag(e){var t=this.tags.indexOf(e);return t<0?this.tags.push(e):this.tags.splice(t,1),this.refresh()}resetTags(){return this.tags=[],this.refresh()}refresh(){this.$stateParams.branch=this.branch,0===this.tags.length?this.$stateParams.tag=void 0:this.$stateParams.tag=this.tags,this.$stateParams.result=this.result;var e={branch:this.$stateParams.branch,tag:this.$stateParams.tag,result:this.$stateParams.result};this.$state.transitionTo(this.$state.current,e,{notify:!1}),this.onChange()}isBuilderDisplayed(e){for(var t=0,s=Array.from(this.tags);t<s.length;t++){var i=s[t];if(e.tags.indexOf(i)<0)return!1}return!0}isTagToggled(e){return this.tags.indexOf(e)>=0}}])}])});
//# sourceMappingURL=scripts.js.map