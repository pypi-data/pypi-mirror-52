<!doctype html>
{% macro epic_progress(epic) -%}
    {% if epic.min_stories %}
    <div class="progress" style="height: 30px">
        <div class="progress-bar bg-{{ color_code(epic.forecast.deadline_quantile if epic.forecast else None) }}"
            role="progressbar"
            style="width: {{ percent_complete(epic) }}%"
            aria-valuenow="{{ epic.stories_done }}"
            aria-valuemin="0"
            aria-valuemax="{{ epic.max_stories }}">
                {{ epic.stories_done }}
                of
                {{ epic.min_stories }}
                {% if epic.max_stories and epic.max_stories != epic.min_stories %} &ndash; {{ epic.max_stories }} {% endif %}
                stories completed
        </div>
    </div>

    <small class="d-none d-print-inline percent-complete">({{ percent_complete(epic) }}%)</small>

    <a class="icon-link d-print-none" href="{{ jira_url }}/issues/?jql={{ epic.story_query | urlencode }}" target="_blank">
        <i class="fas fa-search"></i>
    </a>

    {% if epic_charts[epic.key]['scatterplot'] %}
    <a class="icon-link d-print-none perfundo__link" href="#epic-scatterplot-{{ epic.key | urlencode }}">
        <i class="fas fa-chart-bar"></i>
    </a>
    {% endif %}
    {% if epic_charts[epic.key]['cfd'] %}
    <a class="icon-link d-print-none perfundo__link" href="#epic-cfd-{{ epic.key | urlencode }}">
        <i class="fas fa-chart-area"></i>
    </a>
    {% endif %}

    {% else %}
    Forecast not available
    {% endif %}
{%- endmacro %}
{% macro epic_forecast_percentile(epic) -%}
    {% if epic.forecast %}
        {% if epic.forecast.deadline_quantile is not none %}
        <span class="badge badge-pill badge-{{ color_code(epic.forecast.deadline_quantile) }}">
            {% if epic.forecast.deadline_quantile > 0.95 %}
                > 95%
            {% elif epic.forecast.deadline_quantile < 0.1 %}
                < 10%
            {% else %}
                {{ (epic.forecast.deadline_quantile * 100) | round | int }}%
            {% endif %}
        </span>
        {% endif %}
    {% endif %}
{%- endmacro %}
{%- macro epic_forecast_dates(epic) %}
    {% if epic.forecast %}
        {% for quantile, weeks in epic.forecast.quantiles %}
        <div><small>{{ future_date(weeks).strftime("%d %b %Y") }} <em>@ {{ (quantile * 100) | round | int }}%</em></small></div>
        {% endfor %}
    {% endif %}
{%- endmacro %}
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <meta name="description" content="">
        <meta name="author" content="">

        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/solid.css" integrity="sha384-+0VIRx+yz1WBcCTXBkVQYIBVNEFH1eP6Zknm16roZCyeNg2maWEpk/l/KsyFKs7G" crossorigin="anonymous">
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/fontawesome.css" integrity="sha384-jLuaxTTBR42U2qJ/pm4JRouHkEDHkVqH0T1nyQXn1mZ7Snycpf6Rl25VBNthU4z0" crossorigin="anonymous">

        <!-- Lightbox: https://github.com/maoberlehner/perfundo -->
        <style type="text/css">
            .perfundo__overlay{display:-webkit-box;display:-ms-flexbox;display:flex;visibility:hidden;position:fixed;top:0;right:0;bottom:0;left:0;z-index:999;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;background-color:rgba(0,0,0,.9)}.perfundo__overlay.is-active,.perfundo__overlay:target{visibility:visible}.perfundo__content{max-height:100%;overflow:auto}.is-active>.perfundo__content,:target>.perfundo__content{-webkit-animation:.4s ease-out .2s both;animation:.4s ease-out .2s both;-webkit-animation-name:inherit;animation-name:inherit}.perfundo__html{padding:2em;max-width:42em;background-color:#fff}.perfundo__figure{display:none;margin:1.5em}.is-active>.perfundo__figure,:target>.perfundo__figure{display:block}.perfundo__figure img{display:block;height:0}.perfundo__figcaption{color:#fff}.perfundo__image{max-width:100%;background-size:100%}.perfundo__control{position:absolute}.perfundo__control,.perfundo__control:visited{color:#fff}.perfundo__close{top:1em;right:1em}.perfundo__prev{left:2em}.perfundo__next{right:2em}.perfundo__untarget{position:fixed;top:0}.perfundo__next,.perfundo__prev{top:50%;margin-top:-1.5em;opacity:.2;-webkit-transition:opacity .2s;transition:opacity .2s}.perfundo__next:focus,.perfundo__next:hover,.perfundo__prev:focus,.perfundo__prev:hover{opacity:1}
        </style>

        <style type="text/css">

            .icon-link {
                color: inherit;   
            }

            .icon-link:hover {
                color: inherit;
                text-decoration: none;
            }

            .perfundo__image {
                background-repeat: no-repeat;
            }

            .progress-bar {
                color: #333;
                padding: 0 5px;
                text-align: left;
            }

            .percent-complete {
                font-size: 0.75rem;
            }

            #forecast-view-tabs {
                margin-bottom: 1em;
            }

            @media print {
                
                .progress-bar {
                    color: black;
                    padding: 0 5px;
                    text-align: left;
                }

                .epic-link {
                    color: inherit !important;
                    text-decoration: none !important;
                }

                /* Restore background colours */

                .bg-success {
                    background-color: #28a745;
                }

                .bg-warning {
                    background-color: #ffc107;
                }

                .bg-danger {
                    background-color: #dc3545;
                }

                .bg-primary {
                    background-color: #007bff;
                }

                .badge-success {
                    color: #fff;
                    background-color: #28a745;
                }

                .badge-warning {
                    color: #fff;
                    background-color: #ffc107;
                }

                .badge-danger {
                    color: #fff;
                    background-color: #dc3545;
                }

                .badge-primary {
                    color: #fff;
                    background-color: #007bff;
                }

            }

        </style>

        <title>{{title}}</title>
    </head>

    <body>

        <div class="container mt-4">

            <h1>{{title}}</h1>

            <p>
                This report shows outcomes and their associated epics.
                For each epic, we forecast a completion date based on the expected number
                of stories in the epic, the historical or predicted throughput of that team
                delivering the epic, and the number of stories completed to date.
            </p>

            <p>
                <a class="d-print-none" data-toggle="collapse" href="#configuration">
                    <small>Configuration &raquo;</small>
                </a>
                <div class="collapse" id="configuration">
                    <table class="table table-sm">
                        <tbody>
                            {% if story_query_template %}
                            <tr>
                                <th>Story query template:</th>
                                <td><code>{{story_query_template}}</code></td>
                            </tr>
                            {% endif %}
                            {% if epic_deadline_field %}
                            <tr>
                                <th>Epic deadline field:</th>
                                <td><code>{{epic_deadline_field}}</code></td>
                            </tr>
                            {% endif %}
                            {% if epic_team_field %}
                            <tr>
                                <th>Epic team field:</th>
                                <td><code>{{epic_team_field}}</code></td>
                            </tr>
                            {% endif %}
                            {% if epic_min_stories_field %}
                            <tr>
                                <th>Epic min stories field:</th>
                                <td><code>{{epic_min_stories_field}}</code></td>
                            </tr>
                            {% endif %}
                            {% if epic_max_stories_field %}
                            <tr>
                                <th>Epic max stories field:</th>
                                <td><code>{{epic_max_stories_field}}</code></td>
                            </tr>
                            {% endif %}
                            {% if num_teams > 0 %}
                            <tr>
                                <th>Teams</th>
                                <td>
                                    <table class="table table-sm table-borderless">
                                        <thead>
                                            <tr>
                                                <th scope="col" style="width: 30%">Name</th>
                                                <th scope="col" style="width: 35%">Throughput</th>
                                                <th scope="col" style="width: 15%"></th>
                                                <th scope="col" style="width: 20%">Epic WIP</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for team in teams %}
                                            <tr>
                                                <td>{{ team.name }}</td>
                                                {% if team.min_throughput %}
                                                    <td>{{ team.min_throughput }} &ndash; {{ team.max_throughput }} stories/week</td>
                                                    <td></td>
                                                {% elif team.throughput_samples %}
                                                    <td>
                                                        Historical data
                                                        {%- if team.throughput_samples_window %}
                                                            over {{ team.throughput_samples_window }} weeks
                                                        {% endif -%}
                                                    </td>
                                                    <td>
                                                        <a class="icon-link d-print-none" href="{{ jira_url }}/issues/?jql={{ team.throughput_samples|urlencode }}" target="_blank">
                                                            <i class="fas fa-search"></i>
                                                        </a>
                                                        {% if team_charts[team.name]['scatterplot'] %}
                                                        <a class="icon-link d-print-none perfundo__link" href="#team-scatterplot-{{ team.name | urlencode }}">
                                                            <i class="fas fa-chart-bar"></i>
                                                        </a>
                                                        {% endif %}
                                                        {% if team_charts[team.name]['cfd'] %}
                                                        <a class="icon-link d-print-none perfundo__link" href="#team-cfd-{{ team.name | urlencode }}">
                                                            <i class="fas fa-chart-area"></i>
                                                        </a>
                                                        {% endif %}
                                                        {% if team_charts[team.name]['throughput'] %}
                                                        <a class="icon-link d-print-none perfundo__link" href="#team-throughput-{{ team.name | urlencode }}">
                                                            <i class="fas fa-chart-line"></i>
                                                        </a>
                                                        {% endif %}
                                                    </td>
                                                {% else %}
                                                    <td>(Forecasting disabled)</td>
                                                    <td></td>
                                                {% endif %}
                                                <td>{{ team.wip }}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>

                </div>
            </p>

            {% if have_teams %}
            <ul class="nav nav-tabs" id="forecast-view-tabs" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" id="outcome-tab" data-toggle="tab" href="#by-outcome" role="tab" aria-controls="by-outcome" aria-selected="true">By outcome</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="team-tab" data-toggle="tab" href="#by-team" role="tab" aria-controls="by-team" aria-selected="false">By team</a>
                </li>
            </ul>
            {% endif %}
  
            <div class="tab-content">
                <div class="tab-pane fade show active" id="by-outcome" role="tabpanel" aria-labelledby="outcome-tab">

                    {% for idx, outcome in enumerate(outcomes) %}
                        
                    {% if outcome.name %}
                    <h2>
                        <a name="{{ outcome.key }}">{{ outcome.name }}</a>
                        {% if outcome.is_jira %}
                        <a class="icon-link d-print-none" href="{{ jira_url }}/browse/{{ outcome.key }}" target="_blank"><small class="fas fa-search"></small></a>
                        {% endif %}
                        <a class="d-print-none" data-toggle="collapse" href="#outcome-configuration-{{idx}}"><small class="text-muted">&raquo;</small></a>
                    </h2>
                    {% endif %}

                    <p>
                        <div class="collapse" id="outcome-configuration-{{idx}}">
                            <table class="table table-sm table-hover">
                                <tbody>
                                    <tr>
                                        <th style="width: 20%">Epics query:</th>
                                        <td>
                                            <code>{{ outcome.epic_query }}</code>
                                            <a class="icon-link d-print-none" href="{{ jira_url }}/issues/?jql={{ outcome.epic_query | urlencode }}" target="_blank">
                                                <i class="fas fa-search"></i>
                                            </a>
                                        </td>
                                    </tr>
                                    {% if outcome_charts[outcome.key]['cfd'] %}
                                    <tr>
                                        <th style="width: 20%">Cumulative progress:</th>
                                        <td>
                                            <img style="height: auto; width: auto; max-height: 600px; max-width: 800px" src="data:image/png;base64, {{ outcome_charts[outcome.key]['cfd'] }}" />
                                        </td>
                                    </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </p>

                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th scope="col" style="width: 20%">Epic</th>
                                {% if have_teams %}<th scope="col" style="width: 10%">Team</th>{% endif %}
                                <th scope="col" style="width: 30%">Stories</th>
                                <th scope="col" style="width: 15%">Deadline</th>
                                {% if have_forecasts %} <th scope="col" style="width: 5%"></th> {% endif %}
                                {% if have_forecasts %} <th scope="col" style="width: 20%">Forecast (week starting)</th> {% endif %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for epic in outcome.epics %}
                            <tr>
                                <td><a class="epic-link" href="{{ jira_url }}/browse/{{ epic.key }}" target="_blank">{{ epic.key }}: {{ epic.summary }}</a></td>
                                {% if have_teams %}<td>{{ epic.team.name }}</td>{% endif %}
                                <td>
                                    {{ epic_progress(epic )}}
                                </td>
                                <td>
                                    {% if epic.deadline %}
                                    {{ epic.deadline.strftime("%d %b %Y") }}
                                    {% else %}
                                    <em>N/A</em>
                                    {% endif %}
                                </td>
                                {% if have_forecasts %}
                                <td>
                                    {{ epic_forecast_percentile(epic) }}
                                </td>
                                {% endif %}
                                {% if have_forecasts %}
                                <td>
                                    {{ epic_forecast_dates(epic) }}
                                </td>
                                {% endif %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>

                    {% endfor %}
                </div>

                {% if have_teams %}
                <div class="tab-pane fade" id="by-team" role="tabpanel" aria-labelledby="team-tab">
            
                    {% for team in teams %}
                        
                    <h2>
                        {{ team.name }}
                    </h2>

                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th scope="col" style="width: 20%">Epic</th>
                                {% if have_outcomes %} <th scope="col" style="width: 10%">Outcome</th> {% endif %}
                                <th scope="col" style="width: 30%">Stories</th>
                                <th scope="col" style="width: 15%">Deadline</th>
                                {% if have_forecasts %} <th scope="col" style="width: 5%"></th> {% endif %}
                                {% if have_forecasts %} <th scope="col" style="width: 20%">Forecast (week starting)</th> {% endif %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for epic in epics_by_team[team.name] %}
                            <tr>
                                <td><a class="epic-link" href="{{ jira_url }}/browse/{{ epic.key }}" target="_blank">{{ epic.key }}: {{ epic.summary }}</a></td>
                                {% if have_outcomes %} <td>{{ epic.outcome.name }}</td> {% endif %}
                                <td>
                                    {{ epic_progress(epic )}}
                                </td>
                                <td>
                                    {% if epic.deadline %}
                                    {{ epic.deadline.strftime("%d %b %Y") }}
                                    {% else %}
                                    <em>N/A</em>
                                    {% endif %}
                                </td>
                                {% if have_forecasts %}
                                <td>
                                    {{ epic_forecast_percentile(epic) }}
                                </td>
                                {% endif %}
                                {% if have_forecasts %}
                                <td>
                                    {{ epic_forecast_dates(epic) }}
                                </td>
                                {% endif %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>

                    {% endfor %}

                </div>
                {% endif %}

            </div>

        </div>

        <!-- chart overlays -->

        {% for team in teams %}

            {% if team_charts[team.name]['cfd'] %}
            <div id="team-cfd-{{ team.name | urlencode }}" class="perfundo__overlay fadeInLeft">
                <figure class="perfundo__content perfundo__figure">
                    <figcaption class="perfundo__figcaption">Cumulative Flow Diagram of historical samples for {{ team.name }}</figcaption>
                    <img class="perfundo__image" style="height: auto; width: auto; max-height: 600px; max-width: 800px" src="data:image/png;base64, {{ team_charts[team.name]['cfd'] }}" />
                </figure>
                <a href="#perfundo-untarget" class="perfundo__close perfundo__control">Close</a>
            </div>
            {% endif %}

            {% if team_charts[team.name]['throughput'] %}
            <div id="team-throughput-{{ team.name | urlencode }}" class="perfundo__overlay fadeInLeft">
                <figure class="perfundo__content perfundo__figure">
                    <figcaption class="perfundo__figcaption">Historical weekly throughput for {{ team.name }}</figcaption>
                    <img class="perfundo__image" style="height: auto; width: auto; max-height: 600px; max-width: 800px" src="data:image/png;base64, {{ team_charts[team.name]['throughput'] }}" />
                </figure>
                <a href="#perfundo-untarget" class="perfundo__close perfundo__control">Close</a>
            </div>
            {% endif %}

            {% if team_charts[team.name]['scatterplot'] %}
            <div id="team-scatterplot-{{ team.name | urlencode }}" class="perfundo__overlay fadeInLeft">
                <figure class="perfundo__content perfundo__figure">
                    <figcaption class="perfundo__figcaption">Cycle time scatter plot for {{ team.name }}</figcaption>
                    <img class="perfundo__image" style="height: auto; width: auto; max-height: 600px; max-width: 800px" src="data:image/png;base64, {{ team_charts[team.name]['scatterplot'] }}" />
                </figure>
                <a href="#perfundo-untarget" class="perfundo__close perfundo__control">Close</a>
            </div>
            {% endif %}

        {% endfor %}

        {% for outcome in outcomes %}

            {% for epic in outcome.epics %}

                {% if epic_charts[epic.key]['cfd'] %}
                <div id="epic-cfd-{{ epic.key | urlencode }}" class="perfundo__overlay fadeInLeft">
                    <figure class="perfundo__content perfundo__figure">
                        <figcaption class="perfundo__figcaption">Cumulative Flow Diagram for {{ epic.summary }}</figcaption>
                        <img class="perfundo__image" style="height: auto; width: auto; max-height: 600px; max-width: 800px" src="data:image/png;base64, {{ epic_charts[epic.key]['cfd'] }}" />
                    </figure>
                    <a href="#perfundo-untarget" class="perfundo__close perfundo__control">Close</a>
                </div>
                {% endif %}

                {% if epic_charts[epic.key]['scatterplot'] %}
                <div id="epic-scatterplot-{{ epic.key | urlencode }}" class="perfundo__overlay fadeInLeft">
                    <figure class="perfundo__content perfundo__figure">
                        <figcaption class="perfundo__figcaption">Cycle time scatter plot for {{ epic.summary }}</figcaption>
                        <img class="perfundo__image" style="height: auto; width: auto; max-height: 600px; max-width: 800px" src="data:image/png;base64, {{ epic_charts[epic.key]['scatterplot'] }}" />
                    </figure>
                    <a href="#perfundo-untarget" class="perfundo__close perfundo__control">Close</a>
                </div>
                {% endif %}

            {% endfor %}

        {% endfor %}
        
        <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
        
    </body>
</html>
